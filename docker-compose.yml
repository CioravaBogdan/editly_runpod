services:
  editly:
    container_name: editly-api
    image: editly/editly:latest
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    volumes:
      - "./outputs:/outputs"
      - "./uploads:/app/uploads"
      - "./examples/assets:/app/examples/assets"
      # Mapping pentru fiÈ™ierele de la n8n/external
      - "./temp:/app/temp"
      - "./files:/app/files"
    environment:
      # ConfiguraÈ›ii de bazÄƒ
      - NODE_ENV=production
      - PORT=3001
      # ğŸŒ CLOUDFLARE TUNNEL - External domain for download URLs
      - EXTERNAL_DOMAIN=https://editly.byinfant.com
      # ğŸ® MAXIMUM PERFORMANCE - CPU ONLY
      - USE_GPU=false
      - VIDEO_ENCODER=libx264
      # ğŸš€ PARALLEL PROCESSING - REAL 16-CORE UTILIZATION
      - USE_PARALLEL_PROCESSING=true
      - NVENC_PRESET=medium      # Better quality preset
      - NVENC_CQ=18              # High quality (lower = better)
      - GOP_SIZE=60
      - FFMPEG_THREADS=16  # Use 16 threads for better stability

      # ğŸš€ OptimizÄƒri Node.js pentru server puternic
      - UV_THREADPOOL_SIZE=256          # ğŸš€ DUBLEZ thread pool-ul pentru I/O intensiv
      - NODE_OPTIONS=--max-old-space-size=28672 --max-semi-space-size=2048 --experimental-worker
      - LIBUV_THREAD_POOL_SIZE=256      # ğŸš€ Explicit libuv thread pool

      # ğŸ¬ OptimizÄƒri FFmpeg (opÈ›ional)
      # FFMPEG_OPTIONS is optional and can be overridden by API

      # ğŸ“ Paths
      - TEMP_DIR=/tmp
      - OUTPUT_DIR=/outputs
      - UPLOAD_DIR=/app/uploads

      # âš¡ ConfiguraÈ›ii Editly pentru performanÈ›Äƒ
      - EDITLY_FAST_MODE=false          # ğŸš€ Dezactivat pentru calitate maximÄƒ
      - EDITLY_PARALLEL_RENDERS=32      # ğŸš€ 32 procese paralele pentru 32 cores
      - EDITLY_CLEANUP_TEMP=false
      - EDITLY_LOG_LEVEL=error
      - EDITLY_MAX_QUEUE_SIZE=1000      # ğŸš€ Queue optimizat
      - CANVAS_THREADS=32               # ğŸš€ Canvas Worker Threads
      - RENDER_WORKERS=32               # ğŸš€ Render Workers paraleli

      # ğŸš€ OPTIMIZÄ‚RI pentru 16 cores
      - OMP_NUM_THREADS=16              # ğŸš€ OpenMP pe 16 cores
      - MKL_NUM_THREADS=16              # ğŸš€ Intel MKL pe 16 cores  
      - NUMEXPR_NUM_THREADS=16          # ğŸš€ NumExpr pe 16 cores
      - OPENBLAS_NUM_THREADS=16         # ğŸš€ OpenBLAS pe 16 cores
      
    deploy:
      resources:
        limits:
          cpus: '16.0'      # ğŸš€ 16 THREADS for stability
          memory: 16G       # ğŸš€ 16GB RAM
        reservations:
          cpus: '14.0'      # ğŸš€ Reserve 14 threads
          memory: 12G       # ğŸš€ Reserve 12GB RAM
    
    # ğŸš€ CONFIGURAÈšII EXTREME DE PERFORMANÈšÄ‚ DOCKER
    privileged: true              # ğŸš€ Acces complet la resurse sistem
    security_opt:
      - seccomp:unconfined       # ğŸš€ EliminÄƒ restricÈ›ii seccomp
    ulimits:
      memlock:
        soft: -1                 # ğŸš€ Unlimited memory locking  
        hard: -1
      nofile:
        soft: 1000000            # ğŸš€ 1M file descriptors
        hard: 1000000
      nproc:
        soft: 1000000            # ğŸš€ 1M processes
        hard: 1000000
    shm_size: 4gb                # ğŸš€ 4GB shared memory pentru FFmpeg
    ipc: host                    # ğŸš€ Shared IPC cu host pentru performanÈ›Äƒ
    
    command: ["node", "dist/api-server.js"]
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # RAM disk pentru vitezÄƒ
    tmpfs:
      - /tmp:size=4G,mode=1777
    
    # Logging optimizat
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    
    # SetÄƒri de reÈ›ea pentru performanÈ›Äƒ È™i n8n integration
    networks:
      - editly-network
      - n8n-network
    
    # GPU enablement (Docker Desktop with WSL2 / Linux)
    # gpus: all  # Commented out - requires WSL2 + NVIDIA Container Toolkit

networks:
  editly-network:
    driver: bridge
  n8n-network:
    external: true

volumes:
  outputs:
    driver: local
  uploads:
    driver: local