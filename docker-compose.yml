services:
  editly:
    container_name: editly-api
    image: editly/editly:latest
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    volumes:
      - "./outputs:/outputs"
      - "./uploads:/app/uploads"
      - "./examples/assets:/app/examples/assets"
      # Mapping pentru fiÈ™ierele de la n8n/external
      - "./temp:/app/temp"
      - "./files:/app/files"
    environment:
      # ConfiguraÈ›ii de bazÄƒ
      - NODE_ENV=production
      - PORT=3001
      
      # ğŸš€ OptimizÄƒri Node.js pentru server puternic
      - UV_THREADPOOL_SIZE=256          # ğŸš€ DUBLEZ thread pool-ul pentru I/O intensiv
      - NODE_OPTIONS=--max-old-space-size=28672 --max-semi-space-size=2048 --expose-gc
      
      # ğŸ¬ OptimizÄƒri FFmpeg EXTREME pentru 32 cores
      - FFMPEG_THREADS=32               # ğŸš€ FORÈšEZ 32 threads FFmpeg
      - FFMPEG_OPTIONS=-preset ultrafast -tune zerolatency -threads 32
      
      # ğŸ“ Paths
      - TEMP_DIR=/tmp
      - OUTPUT_DIR=/outputs
      - UPLOAD_DIR=/app/uploads
      
      # âš¡ ConfiguraÈ›ii Editly pentru performanÈ›Äƒ EXTREME
      - EDITLY_FAST_MODE=true
      - EDITLY_PARALLEL_RENDERS=64      # ğŸš€ DUBLEZ paralelismul (64)
      - EDITLY_CLEANUP_TEMP=false
      - EDITLY_LOG_LEVEL=error
      - EDITLY_MAX_QUEUE_SIZE=2000      # ğŸš€ DUBLEZ queue size
      
      # ğŸš€ OPTIMIZÄ‚RI EXTREME LINUX CONTAINER
      - OMP_NUM_THREADS=32              # ğŸš€ OpenMP pe toate cores
      - MKL_NUM_THREADS=32              # ğŸš€ Intel MKL pe toate cores  
      - NUMEXPR_NUM_THREADS=32          # ğŸš€ NumExpr pe toate cores
      - OPENBLAS_NUM_THREADS=32         # ğŸš€ OpenBLAS pe toate cores
      
    deploy:
      resources:
        limits:
          cpus: '32.0'      # ğŸš€ TOATE CPU-urile disponibile (32)
          memory: 30G       # ğŸš€ APROAPE TOATÄ‚ MEMORIA (30GB din 32GB)
        reservations:
          cpus: '24.0'      # ğŸš€ Reserve majoritatea cores (24)
          memory: 20G       # ğŸš€ Reserve memoria pentru procesare
    
    # ğŸš€ CONFIGURAÈšII EXTREME DE PERFORMANÈšÄ‚ DOCKER
    privileged: true              # ğŸš€ Acces complet la resurse sistem
    security_opt:
      - seccomp:unconfined       # ğŸš€ EliminÄƒ restricÈ›ii seccomp
    ulimits:
      memlock:
        soft: -1                 # ğŸš€ Unlimited memory locking  
        hard: -1
      nofile:
        soft: 1000000            # ğŸš€ 1M file descriptors
        hard: 1000000
      nproc:
        soft: 1000000            # ğŸš€ 1M processes
        hard: 1000000
    shm_size: 8gb                # ğŸš€ 8GB shared memory pentru FFmpeg
    ipc: host                    # ğŸš€ Shared IPC cu host pentru performanÈ›Äƒ
    
    command: ["node", "dist/api-server.js"]
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # RAM disk pentru super vitezÄƒ
    tmpfs:
      - /tmp:size=8G,mode=1777
    
    # Logging optimizat
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
    
    # SetÄƒri de reÈ›ea pentru performanÈ›Äƒ
    networks:
      - editly-network

networks:
  editly-network:
    driver: bridge

volumes:
  outputs:
    driver: local
  uploads:
    driver: local