{
  "name": "ğŸ¬ Editly Dynamic Duration Video Creator",
  "nodes": [
    {
      "parameters": {},
      "id": "webhook-start",
      "name": "ğŸ“¥ Webhook Start",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "sample-data",
              "name": "sampleData",
              "value": "[\n  {\n    \"audioPath\": \"/app/uploads/files-1753801198963-967848345.mp3\",\n    \"imagePath\": \"/app/uploads/files-1753809979219-248490257.png\"\n  },\n  {\n    \"audioPath\": \"/app/uploads/files-1753801198969-641241060.mp3\",\n    \"imagePath\": \"/app/uploads/files-1753809979224-923577472.png\"\n  },\n  {\n    \"audioPath\": \"/app/uploads/files-1753801198962-600451434.mp3\",\n    \"imagePath\": \"/app/uploads/files-1753809979226-469814619.png\"\n  }\n]",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "sample-data-node",
      "name": "ğŸ“‹ Sample Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [460, 300]
    },
    {
      "parameters": {
        "jsCode": "// ğŸ¬ EDITLY VIDEO CREATOR - DURATÄ‚ DINAMICÄ‚ BAZATÄ‚ PE AUDIO\n// âœ… RezoluÈ›ie: 1024x1536 | DuratÄƒ: bazatÄƒ pe audio + buffer | Calitate maximÄƒ\n\nconst allPages = $input.all();\n\n// --- ğŸ¯ CONFIGURAÈšIE VIDEO ---\nconst VIDEO_CONFIG = {\n  width: 1024,              // LÄƒÈ›imea cerutÄƒ\n  height: 1536,             // ÃnÄƒlÈ›imea cerutÄƒ\n  fps: 30,                  // Frame rate pentru calitate maximÄƒ\n  minDuration: 4,           // DuratÄƒ minimÄƒ per clip (secunde)\n  maxDuration: 10,          // DuratÄƒ maximÄƒ per clip (secunde)\n  audioBuffer: 2,           // Buffer minim Ã®ntre audio-uri (secunde)\n  silenceBetween: 2         // PauzÄƒ minimÄƒ Ã®ntre clipuri (secunde)\n};\n\n// ğŸ§® FUNCÈšIE PENTRU CALCULAREA DURATEI CLIPULUI\nfunction calculateClipDuration(audioDuration) {\n  if (!audioDuration) {\n    // FÄƒrÄƒ audio - duratÄƒ standard\n    return VIDEO_CONFIG.minDuration;\n  }\n  \n  if (audioDuration <= 4) {\n    // Audio scurt (â‰¤4s) â†’ clip de 4 secunde\n    return 4;\n  }\n  \n  if (audioDuration <= 5) {\n    // Audio 5s â†’ clip de 8 secunde (5s audio + 3s buffer)\n    return 8;\n  }\n  \n  if (audioDuration <= 9) {\n    // Audio 6-9s â†’ clip de 10 secunde (audio + 1-4s buffer)\n    return 10;\n  }\n  \n  // Audio foarte lung â†’ limiteazÄƒ la maxim\n  return VIDEO_CONFIG.maxDuration;\n}\n\n// ProcesÄƒm datele de test\nconst testData = JSON.parse($json.sampleData);\n\nconsole.log(`ğŸ¬ Procesare carte digitalÄƒ: ${testData.length} pagini`);\nconsole.log(`ğŸ“ RezoluÈ›ie video: ${VIDEO_CONFIG.width}x${VIDEO_CONFIG.height}`);\n\n// ğŸš€ CreÄƒm array-ul de clipuri pentru Editly\nconst clips = [];\nlet totalEstimatedDuration = 0;\n\n// ProcesÄƒm fiecare paginÄƒ\nfor (let index = 0; index < testData.length; index++) {\n  const item = testData[index];\n  const { audioPath, imagePath } = item;\n  \n  // VerificÄƒm cÄƒ avem imagine (obligatoriu)\n  if (!imagePath) {\n    console.warn(`âš ï¸  Pagina ${index + 1} nu are imagine - omisÄƒ`);\n    continue;\n  }\n  \n  // SimulÄƒm detectarea duratei audio (Ã®n implementarea realÄƒ foloseÈ™ti ffprobe)\n  let audioDuration = 0;\n  let clipDuration = VIDEO_CONFIG.minDuration;\n  \n  if (audioPath) {\n    // Pentru demo, simulÄƒm duratÄƒ audio Ã®ntre 3-9 secunde\n    audioDuration = Math.floor(Math.random() * 7) + 3;\n    clipDuration = calculateClipDuration(audioDuration);\n    \n    console.log(`ğŸµ Pagina ${index + 1}: Audio ${audioDuration}s â†’ Clip ${clipDuration}s`);\n  } else {\n    console.log(`ğŸ–¼ï¸  Pagina ${index + 1}: FÄƒrÄƒ audio â†’ Clip ${clipDuration}s`);\n  }\n  \n  // Construim clip-ul conform documentaÈ›iei Editly\n  const clip = {\n    duration: clipDuration,\n    layers: [\n      {\n        type: \"image\",\n        path: imagePath,\n        resizeMode: \"cover\"  // Cover pentru a umple ecranul\n      }\n    ]\n  };\n  \n  // AdÄƒugÄƒm audio dacÄƒ existÄƒ\n  if (audioPath) {\n    clip.layers.push({\n      type: \"audio\", \n      path: audioPath,\n      mixVolume: 1.0,  // Volum original - NU modificÄƒm\n      // Audio-ul va rula natural durata sa realÄƒ\n    });\n  }\n  \n  // AdÄƒugÄƒm clip de liniÈ™te Ã®ntre pagini (pentru separare clarÄƒ)\n  if (index < testData.length - 1) {\n    clips.push(clip);\n    \n    // Clip de liniÈ™te Ã®ntre pagini\n    clips.push({\n      duration: VIDEO_CONFIG.silenceBetween,\n      layers: [\n        {\n          type: \"fill-color\",\n          color: \"#000000\"  // Ecran negru pentru pauzÄƒ\n        }\n      ]\n    });\n    \n    totalEstimatedDuration += clipDuration + VIDEO_CONFIG.silenceBetween;\n  } else {\n    clips.push(clip);\n    totalEstimatedDuration += clipDuration;\n  }\n  \n  console.log(`âœ… Pagina ${index + 1}: ${clipDuration}s (audio: ${audioDuration}s)`);\n}\n\n// ğŸ¯ ConfiguraÈ›ia finalÄƒ Editly - CALITATE MAXIMÄ‚\nconst editSpec = {\n  // SetÄƒri video principale\n  width: VIDEO_CONFIG.width,\n  height: VIDEO_CONFIG.height,\n  fps: VIDEO_CONFIG.fps,\n  \n  // Array-ul de clipuri cu duratÄƒ dinamicÄƒ\n  clips: clips,\n  \n  // ğŸš€ SETÄ‚RI PENTRU CALITATE MAXIMÄ‚ (nu fast mode)\n  fast: false,  // ğŸ¯ DEZACTIVAT pentru calitate maximÄƒ\n  keepSourceAudio: true,  // PÄƒstrÄƒm calitatea audio originalÄƒ\n  \n  // ğŸµ SetÄƒri audio - calitate maximÄƒ\n  audioCodec: \"aac\",\n  audioBitrate: \"192k\",   // Bitrate mai mare pentru calitate\n  \n  // ğŸ¬ SetÄƒri video - calitate maximÄƒ\n  videoBitrate: \"5000k\",  // Bitrate crescut pentru calitate 1024x1536\n  videoCodec: \"libx264\",\n  \n  // FÄƒrÄƒ tranziÈ›ii pentru claritate\n  defaults: {\n    transition: null\n  },\n  \n  // ğŸš€ Argumente optimizate pentru calitate + performanÈ›Äƒ\n  customOutputArgs: [\n    // Video encoding pentru calitate\n    \"-c:v\", \"libx264\",\n    \"-preset\", \"medium\",    // Preset balansat calitate/vitezÄƒ\n    \"-crf\", \"18\",           // Calitate foarte bunÄƒ (18 = aproape lossless)\n    \"-profile:v\", \"high\",\n    \"-level\", \"4.0\",\n    \"-pix_fmt\", \"yuv420p\",\n    \n    // Audio encoding pentru calitate\n    \"-c:a\", \"aac\",\n    \"-b:a\", \"192k\",         // Bitrate audio crescut\n    \"-ar\", \"48000\",         // Sample rate ridicat\n    \"-ac\", \"2\",             // Stereo\n    \n    // OptimizÄƒri pentru streaming\n    \"-movflags\", \"+faststart\",\n    \n    // Multi-threading pentru performanÈ›Äƒ\n    \"-threads\", \"0\"         // FoloseÈ™te toate cores-urile\n  ]\n};\n\n// ğŸ“ GenerÄƒm numele fiÈ™ierului\nconst timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);\nconst outputFilename = `carte_digitala_HD_${timestamp}.mp4`;\n\n// ğŸ“Š Statistici finale\nconst validClips = clips.filter(c => c.layers.some(l => l.type === \"image\")).length;\nconst audioClips = clips.filter(c => c.layers.some(l => l.type === \"audio\")).length;\nconst totalMinutes = Math.floor(totalEstimatedDuration / 60);\nconst totalSeconds = totalEstimatedDuration % 60;\n\nconsole.log(\"\\nğŸ“Š === REZUMAT FINAL ===\");\nconsole.log(`âœ… Pagini procesate: ${validClips}`);\nconsole.log(`ğŸµ Pagini cu audio: ${audioClips}`);\nconsole.log(`â±ï¸  DuratÄƒ totalÄƒ estimatÄƒ: ${totalMinutes}m ${totalSeconds}s`);\nconsole.log(`ğŸ“ Nume fiÈ™ier: ${outputFilename}`);\nconsole.log(`ğŸ¬ Calitate: HD ${VIDEO_CONFIG.width}x${VIDEO_CONFIG.height} @ ${VIDEO_CONFIG.fps}fps`);\nconsole.log(`ğŸ”Š Audio: Calitate originalÄƒ, fÄƒrÄƒ modificÄƒri`);\n\n// Verificare finalÄƒ\nif (validClips === 0) {\n  throw new Error(\"âŒ Nu existÄƒ clipuri valide de procesat!\");\n}\n\n// ğŸ¬ ReturnÄƒm configuraÈ›ia pentru Editly\nreturn {\n  editSpec: editSpec,\n  outputFilename: outputFilename,\n  stats: {\n    totalPages: validClips,\n    totalDuration: totalEstimatedDuration,\n    withAudio: audioClips,\n    resolution: `${VIDEO_CONFIG.width}x${VIDEO_CONFIG.height}`,\n    quality: \"HD_Maximum\",\n    audioQuality: \"Original_192k\"\n  }\n};"
      },
      "id": "dynamic-duration-processor",
      "name": "ğŸ¬ Dynamic Duration Processor",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "url": "http://editly-api:3001/edit",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "editSpec",
              "value": "={{ $json.editSpec }}"
            },
            {
              "name": "outputFilename",
              "value": "={{ $json.outputFilename }}"
            }
          ]
        },
        "options": {
          "timeout": 1800000
        }
      },
      "id": "editly-api-call",
      "name": "ğŸš€ Editly API Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "success-condition",
              "leftValue": "={{ $json.message }}",
              "rightValue": "Video editing completed successfully",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "success-check",
      "name": "âœ… Success Check",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "url": "={{ $json.downloadUrl }}",
        "options": {
          "timeout": 300000
        }
      },
      "id": "download-video",
      "name": "ğŸ“¥ Download Video",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1340, 240]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "final-result",
              "name": "result",
              "value": "{\n  \"status\": \"success\",\n  \"message\": \"âœ… Video creat cu succes!\",\n  \"videoUrl\": \"{{ $('ğŸš€ Editly API Call').item.json.downloadUrl }}\",\n  \"filename\": \"{{ $('ğŸš€ Editly API Call').item.json.outputFilename }}\",\n  \"stats\": {{ $('ğŸ¬ Dynamic Duration Processor').item.json.stats }},\n  \"fileSize\": \"{{ $binary.data.fileSize }}MB\",\n  \"processingTime\": \"{{ $workflow.timestamp - $('ğŸ“¥ Webhook Start').item.json.timestamp }}ms\"\n}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "success-result",
      "name": "ğŸ‰ Success Result",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1560, 240]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-result", 
              "name": "error",
              "value": "{\n  \"status\": \"error\",\n  \"message\": \"âŒ Eroare la procesarea video\",\n  \"details\": \"{{ $json.error || $json.message }}\",\n  \"timestamp\": \"{{ new Date().toISOString() }}\"\n}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "error-result",
      "name": "âŒ Error Result", 
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1340, 360]
    }
  ],
  "connections": {
    "ğŸ“¥ Webhook Start": {
      "main": [
        [
          {
            "node": "ğŸ“‹ Sample Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“‹ Sample Data": {
      "main": [
        [
          {
            "node": "ğŸ¬ Dynamic Duration Processor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¬ Dynamic Duration Processor": {
      "main": [
        [
          {
            "node": "ğŸš€ Editly API Call",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš€ Editly API Call": {
      "main": [
        [
          {
            "node": "âœ… Success Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœ… Success Check": {
      "main": [
        [
          {
            "node": "ğŸ“¥ Download Video",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âŒ Error Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Download Video": {
      "main": [
        [
          {
            "node": "ğŸ‰ Success Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-07-29T20:45:00.000Z",
  "versionId": "1"
}